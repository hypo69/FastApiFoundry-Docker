# ğŸ—ï¸ ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° Foundry - FastAPI Foundry

## ğŸ“‹ ĞĞ±Ğ·Ğ¾Ñ€ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñ‹

FastAPI Foundry Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ **Microsoft Foundry Local CLI** ĞºĞ°Ğº ÑĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ… AI Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹. Ğ­Ñ‚Ğ¾ ÑĞ¾Ğ·Ğ´Ğ°ĞµÑ‚ Ğ¼Ğ½Ğ¾Ğ³Ğ¾ÑƒÑ€Ğ¾Ğ²Ğ½ĞµĞ²ÑƒÑ Ğ°Ñ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ñƒ Ğ´Ğ»Ñ Ñ€Ğ°Ğ±Ğ¾Ñ‚Ñ‹ Ñ AI.

## ğŸ”„ Ğ¡Ñ…ĞµĞ¼Ğ° Ğ²Ğ·Ğ°Ğ¸Ğ¼Ğ¾Ğ´ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ñ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    HTTP REST API    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    CLI Commands    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   FastAPI       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚  Foundry Local   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º â”‚   AI Models     â”‚
â”‚   (Port 9696)   â”‚                     â”‚  (Port 50477)    â”‚                    â”‚   (ONNX/Local)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                        â”‚                                        â”‚
        â–¼                                        â–¼                                        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Web Interface  â”‚                     â”‚  Model Manager   â”‚                    â”‚  Model Storage  â”‚
â”‚  (Static Files) â”‚                     â”‚  (Load/Unload)   â”‚                    â”‚  (~/.foundry)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ§© ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚Ñ‹ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹

### 1. FastAPI Server (Port 9696)
- **Ğ Ğ¾Ğ»ÑŒ**: REST API Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ Ğ´Ğ»Ñ ĞºĞ»Ğ¸ĞµĞ½Ñ‚Ğ¾Ğ²
- **Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸**: 
  - ĞĞ±Ñ€Ğ°Ğ±Ğ¾Ñ‚ĞºĞ° HTTP Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²
  - Ğ’Ğ°Ğ»Ğ¸Ğ´Ğ°Ñ†Ğ¸Ñ Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ²
  - ĞœĞ°Ñ€ÑˆÑ€ÑƒÑ‚Ğ¸Ğ·Ğ°Ñ†Ğ¸Ñ Ğº Foundry
  - Ğ’ĞµĞ±-Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
- **Ğ¤Ğ°Ğ¹Ğ»Ñ‹**: `src/api/`, `run.py`

### 2. Foundry Local CLI (Port 50477)
- **Ğ Ğ¾Ğ»ÑŒ**: Ğ¡ĞµÑ€Ğ²Ğ¸Ñ Ğ´Ğ»Ñ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ° AI Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹
- **Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸**:
  - Ğ—Ğ°Ğ³Ñ€ÑƒĞ·ĞºĞ°/Ğ²Ñ‹Ğ³Ñ€ÑƒĞ·ĞºĞ° Ğ¼Ğ¾Ğ´ĞµĞ»ĞµĞ¹
  - Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ°
  - Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ñ€ĞµÑÑƒÑ€ÑĞ°Ğ¼Ğ¸
- **ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹**: `foundry service start/stop`

### 3. AI Models (Local Storage)
- **Ğ Ğ¾Ğ»ÑŒ**: Ğ›Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ AI Ğ¼Ğ¾Ğ´ĞµĞ»Ğ¸ Ğ² Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ‚Ğµ ONNX
- **Ğ Ğ°ÑĞ¿Ğ¾Ğ»Ğ¾Ğ¶ĞµĞ½Ğ¸Ğµ**: `~/.foundry/models/`
- **Ğ¢Ğ¸Ğ¿Ñ‹**: Qwen, DeepSeek, Mistral, Llama

### 4. Web Interface (Static Files)
- **Ğ Ğ¾Ğ»ÑŒ**: ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ÑŒÑĞºĞ¸Ğ¹ Ğ¸Ğ½Ñ‚ĞµÑ€Ñ„ĞµĞ¹Ñ
- **Ğ¤Ğ°Ğ¹Ğ»Ñ‹**: `static/index.html`, `static/chat.html`
- **Ğ¤ÑƒĞ½ĞºÑ†Ğ¸Ğ¸**: Ğ§Ğ°Ñ‚, ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»ÑĞ¼Ğ¸, Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³

## ğŸ”Œ API Integration

### FastAPI â†’ Foundry Communication

```python
# src/models/foundry_client.py
class FoundryClient:
    def __init__(self, base_url="http://localhost:50477/v1/"):
        self.base_url = base_url
    
    async def generate_text(self, prompt, model, **kwargs):
        """Ğ“ĞµĞ½ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ñ‚ĞµĞºÑÑ‚Ğ° Ñ‡ĞµÑ€ĞµĞ· Foundry API"""
        response = await self.client.post(
            f"{self.base_url}completions",
            json={
                "model": model,
                "prompt": prompt,
                "max_tokens": kwargs.get("max_tokens", 100),
                "temperature": kwargs.get("temperature", 0.7)
            }
        )
        return response.json()
```

### Request Flow

```
1. Client Request â†’ FastAPI Endpoint
   POST /api/v1/generate
   {
     "prompt": "Hello",
     "model": "qwen2.5-0.5b-instruct-generic-cpu:4"
   }

2. FastAPI â†’ Foundry API
   POST http://localhost:50477/v1/completions
   {
     "model": "qwen2.5-0.5b-instruct-generic-cpu:4",
     "prompt": "Hello",
     "max_tokens": 100
   }

3. Foundry â†’ AI Model
   CLI: foundry run qwen2.5-0.5b-instruct-generic-cpu:4

4. Response Chain
   AI Model â†’ Foundry â†’ FastAPI â†’ Client
```

## ğŸš€ Startup Sequence

### ĞŸÑ€Ğ°Ğ²Ğ¸Ğ»ÑŒĞ½Ñ‹Ğ¹ Ğ¿Ğ¾Ñ€ÑĞ´Ğ¾Ğº Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°

```powershell
# 1. Ğ¡ĞĞĞ§ĞĞ›Ğ - Foundry ÑĞµÑ€Ğ²ĞµÑ€
foundry service start
# ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ: Foundry Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑÑ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ 50477

# 2. ĞŸĞĞ¢ĞĞœ - FastAPI ÑĞµÑ€Ğ²ĞµÑ€  
python run.py
# ĞĞ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ğµ: FastAPI Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑÑ Ğ½Ğ° Ğ¿Ğ¾Ñ€Ñ‚Ñƒ 9696
```

### ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ Ğ·Ğ°Ğ¿ÑƒÑĞº (start.ps1)

```powershell
# start.ps1 Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸:
# 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµÑ‚ Ğ·Ğ°Ğ¿ÑƒÑ‰ĞµĞ½Ğ½Ñ‹Ğ¹ Foundry
# 2. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ Foundry ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
# 3. ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµÑ‚ Ğ¿Ğ¾Ñ€Ñ‚ Foundry
# 4. ĞŸĞµÑ€ĞµĞ´Ğ°ĞµÑ‚ Ğ¿Ğ¾Ñ€Ñ‚ Ğ² FastAPI Ñ‡ĞµÑ€ĞµĞ· Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
# 5. Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµÑ‚ FastAPI ÑĞµÑ€Ğ²ĞµÑ€
```

## ğŸ”§ Configuration Integration

### config.json â†’ Environment Variables

```json
{
  "foundry_ai": {
    "base_url": "http://localhost:50477/v1/",
    "default_model": "qwen2.5-0.5b-instruct-generic-cpu:4"
  }
}
```

```powershell
# start.ps1 ÑƒÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
$env:FOUNDRY_BASE_URL = "http://localhost:50477/v1/"
$env:FOUNDRY_PORT = "50477"
```

```python
# src/core/config.py Ğ¸ÑĞ¿Ğ¾Ğ»ÑŒĞ·ÑƒĞµÑ‚ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ
import os
foundry_url = os.getenv('FOUNDRY_BASE_URL', config['foundry_ai']['base_url'])
```

## ğŸ“Š Model Management

### Model Lifecycle

```
1. Model Discovery
   foundry models list â†’ Available models

2. Model Loading  
   foundry models load <model_id> â†’ Model in memory

3. Model Usage
   FastAPI â†’ Foundry API â†’ Loaded model

4. Model Unloading
   foundry models unload <model_id> â†’ Free memory
```

### Model Storage Structure

```
~/.foundry/
â”œâ”€â”€ models/
â”‚   â”œâ”€â”€ qwen2.5-0.5b-instruct-generic-cpu:4/
â”‚   â”‚   â”œâ”€â”€ model.onnx
â”‚   â”‚   â”œâ”€â”€ tokenizer.json
â”‚   â”‚   â””â”€â”€ config.json
â”‚   â””â”€â”€ deepseek-r1-distill-qwen-7b-generic-cpu:3/
â”‚       â”œâ”€â”€ model.onnx
â”‚       â””â”€â”€ ...
â”œâ”€â”€ cache/
â””â”€â”€ logs/
```

## ğŸ” Health Monitoring

### Multi-level Health Checks

```python
# 1. FastAPI Health
GET /api/v1/health
{
  "status": "healthy",
  "foundry_status": "connected"
}

# 2. Foundry Health  
GET http://localhost:50477/v1/models
{
  "models": [...]
}

# 3. Model Health
POST http://localhost:50477/v1/completions
{
  "model": "test-model",
  "prompt": "test"
}
```

### Health Check Flow

```
Client â†’ FastAPI Health Endpoint
         â†“
FastAPI â†’ Foundry API Check
         â†“  
Foundry â†’ Model Availability Check
         â†“
Response Chain: Model â†’ Foundry â†’ FastAPI â†’ Client
```

## ğŸ› ï¸ Error Handling

### Error Propagation

```
AI Model Error â†’ Foundry Error Response â†’ FastAPI Error Handler â†’ Client Error
```

### Common Error Scenarios

1. **Foundry Not Running**
   ```json
   {
     "error": "Foundry service unavailable",
     "detail": "Connection refused to http://localhost:50477",
     "status_code": 503
   }
   ```

2. **Model Not Loaded**
   ```json
   {
     "error": "Model not available",
     "detail": "Model 'qwen2.5-0.5b' is not loaded",
     "status_code": 404
   }
   ```

3. **Generation Timeout**
   ```json
   {
     "error": "Generation timeout",
     "detail": "Request timed out after 300 seconds",
     "status_code": 408
   }
   ```

## ğŸ”„ Port Management

### Dynamic Port Discovery

```powershell
# start.ps1 Ğ°Ğ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ½Ğ°Ñ…Ğ¾Ğ´Ğ¸Ñ‚ Ğ¿Ğ¾Ñ€Ñ‚ Foundry
$foundryProcesses = Get-Process -Name "foundry"
$netstatOutput = netstat -ano | Select-String "$($foundryProcesses[0].Id)"
# ĞŸĞ°Ñ€ÑĞ¸Ğ½Ğ³ Ğ¿Ğ¾Ñ€Ñ‚Ğ° Ğ¸Ğ· netstat
```

### Port Conflict Resolution

```json
{
  "port_management": {
    "conflict_resolution": "kill_process",
    "auto_find_free_port": true,
    "port_range_start": 9696,
    "port_range_end": 9796
  }
}
```

## ğŸ” Security Architecture

### API Security Layers

```
1. CORS Protection (FastAPI level)
2. API Key Authentication (Optional)
3. Rate Limiting (Configurable)
4. Input Validation (Pydantic models)
5. Foundry Internal Security
```

### Secure Communication

```
Client â†’ HTTPS (Optional) â†’ FastAPI â†’ HTTP (Local) â†’ Foundry â†’ Local Models
```

## ğŸ“ˆ Performance Considerations

### Optimization Points

1. **Connection Pooling**: FastAPI â†’ Foundry
2. **Model Caching**: Keep models loaded in Foundry
3. **Request Batching**: Multiple prompts in one request
4. **Async Processing**: Non-blocking I/O

### Resource Management

```
FastAPI Memory: ~100MB (Base)
Foundry Memory: ~500MB (Service)
Model Memory: 500MB - 8GB (Per model)
Total: 1GB - 16GB (Depending on models)
```

## ğŸ”§ Development Architecture

### Code Organization

```
src/
â”œâ”€â”€ api/                 # FastAPI application
â”‚   â”œâ”€â”€ app.py          # Application factory
â”‚   â”œâ”€â”€ main.py         # Entry point
â”‚   â””â”€â”€ endpoints/      # API routes
â”œâ”€â”€ models/             # Foundry integration
â”‚   â”œâ”€â”€ foundry_client.py
â”‚   â””â”€â”€ model_manager.py
â”œâ”€â”€ core/               # Configuration
â””â”€â”€ utils/              # Utilities
```

### Extension Points

1. **Custom Endpoints**: Add new API routes
2. **Model Adapters**: Support new model types
3. **Middleware**: Add custom processing
4. **Plugins**: Extend functionality

---

**Ğ¡Ğ»ĞµĞ´ÑƒÑÑ‰Ğ¸Ğ¹ ÑˆĞ°Ğ³**: [Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¾Ğ´ĞµĞ»ÑĞ¼Ğ¸](models-management.md)