<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FastAPI Foundry - Control Panel</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f5f5; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
        .status-bar { background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .status-item { text-align: center; }
        .status-value { font-size: 1.5rem; font-weight: bold; }
        .status-online { color: #28a745; }
        .status-offline { color: #dc3545; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card h3 { margin-bottom: 15px; color: #333; }
        .chat-container { height: 400px; border: 1px solid #ddd; border-radius: 5px; padding: 10px; overflow-y: auto; margin-bottom: 10px; background: #fafafa; }
        .message { margin-bottom: 10px; padding: 10px; border-radius: 5px; }
        .message.user { background: #667eea; color: white; text-align: right; }
        .message.assistant { background: #e9ecef; color: #333; }
        .input-group { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select, textarea { padding: 10px; border: 1px solid #ddd; border-radius: 5px; flex: 1; }
        button { padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        button:hover { background: #5a6fd8; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        .btn-success { background: #28a745; }
        .btn-success:hover { background: #218838; }
        .btn-danger { background: #dc3545; }
        .btn-danger:hover { background: #c82333; }
        .models-list { max-height: 300px; overflow-y: auto; }
        .model-item { padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 10px; display: flex; justify-content: between; align-items: center; }
        .logs { font-family: monospace; font-size: 0.9rem; background: #f8f9fa; padding: 10px; border-radius: 5px; height: 200px; overflow-y: auto; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ FastAPI Foundry Control Panel</h1>
            <p>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω—ã–º–∏ AI –º–æ–¥–µ–ª—è–º–∏ —á–µ—Ä–µ–∑ Foundry</p>
        </div>

        <div class="status-bar">
            <div class="status-item">
                <div id="api-status" class="status-value status-offline">‚óè</div>
                <div>API Server</div>
            </div>
            <div class="status-item">
                <div id="foundry-status" class="status-value status-offline">‚óè</div>
                <div>Foundry</div>
            </div>
            <div class="status-item">
                <div id="models-count" class="status-value">0</div>
                <div>Models</div>
            </div>
            <div class="status-item">
                <button onclick="refreshStatus()">üîÑ Refresh</button>
            </div>
        </div>

        <div class="grid">
            <!-- Chat Panel -->
            <div class="card">
                <h3>üí¨ AI Chat</h3>
                <div class="input-group">
                    <select id="model-select">
                        <option value="">Loading models...</option>
                    </select>
                    <button onclick="loadModels()">üîÑ</button>
                </div>
                <div id="chat-messages" class="chat-container">
                    <div style="text-align: center; color: #666; margin-top: 50px;">
                        Start chatting with AI models
                    </div>
                </div>
                <div class="input-group">
                    <input type="text" id="chat-input" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                    <button onclick="sendMessage()">Send</button>
                </div>
                <div class="input-group">
                    <label>Temperature: <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" style="width: 100px;"></label>
                    <span id="temp-value">0.7</span>
                </div>
            </div>

            <!-- Foundry Management -->
            <div class="card">
                <h3>‚öôÔ∏è Foundry Management</h3>
                <div class="input-group">
                    <button id="start-foundry" class="btn-success" onclick="startFoundry()">‚ñ∂Ô∏è Start Foundry</button>
                    <button id="stop-foundry" class="btn-danger" onclick="stopFoundry()">‚èπÔ∏è Stop Foundry</button>
                </div>
                <div class="models-list" id="models-list">
                    <div style="text-align: center; color: #666; padding: 20px;">
                        Click "Load Models" to see available models
                    </div>
                </div>
                <button onclick="loadModels()" style="width: 100%; margin-top: 10px;">üìã Load Models</button>
            </div>

            <!-- System Info -->
            <div class="card">
                <h3>üìä System Info</h3>
                <div id="system-info">
                    <p><strong>API URL:</strong> <span id="api-url">http://localhost:9696</span></p>
                    <p><strong>Foundry URL:</strong> <span id="foundry-url">http://localhost:50477</span></p>
                    <p><strong>Status:</strong> <span id="system-status">Checking...</span></p>
                </div>
                <div class="logs" id="system-logs">
                    System logs will appear here...
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <h3>‚ö° Quick Actions</h3>
                <button onclick="testConnection()" style="width: 100%; margin-bottom: 10px;">üîç Test Connection</button>
                <button onclick="generateSample()" style="width: 100%; margin-bottom: 10px;">‚ú® Generate Sample</button>
                <button onclick="clearChat()" style="width: 100%; margin-bottom: 10px;">üóëÔ∏è Clear Chat</button>
                <button onclick="exportLogs()" style="width: 100%;">üíæ Export Logs</button>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = 'http://localhost:9696/api/v1';
        let currentModel = '';
        let chatHistory = [];

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            refreshStatus();
            loadModels();
            
            // Update temperature display
            document.getElementById('temperature').addEventListener('input', function() {
                document.getElementById('temp-value').textContent = this.value;
            });
            
            // Auto-refresh status every 30 seconds
            setInterval(refreshStatus, 30000);
        });

        async function refreshStatus() {
            try {
                // Check API health
                const response = await fetch(`${API_BASE}/health`);
                const data = await response.json();
                
                console.log('Health data:', data);
                
                document.getElementById('api-status').className = 'status-value status-online';
                document.getElementById('foundry-status').className = data.foundry_status === 'healthy' ? 'status-value status-online' : 'status-value status-offline';
                document.getElementById('models-count').textContent = data.models_count || 0;
                
                // Update system info
                document.getElementById('system-status').textContent = `API: ${data.status}, Foundry: ${data.foundry_status}`;
                
                addLog(`‚úÖ API: ${data.status}, Foundry: ${data.foundry_status}, Models: ${data.models_count || 0}`);
                
            } catch (error) {
                document.getElementById('api-status').className = 'status-value status-offline';
                document.getElementById('foundry-status').className = 'status-value status-offline';
                document.getElementById('models-count').textContent = '0';
                document.getElementById('system-status').textContent = 'Connection error';
                addLog(`‚ùå Connection error: ${error.message}`);
            }
        }

        async function loadModels() {
            try {
                const response = await fetch(`${API_BASE}/models`);
                const data = await response.json();
                
                console.log('Models data:', data);
                
                const select = document.getElementById('model-select');
                const list = document.getElementById('models-list');
                
                if (data.success && data.models && data.models.length > 0) {
                    // Update select
                    select.innerHTML = '<option value="">Select model...</option>';
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model.id;
                        option.textContent = model.id;
                        select.appendChild(option);
                    });
                    
                    // Update models list
                    list.innerHTML = '';
                    data.models.forEach(model => {
                        const div = document.createElement('div');
                        div.className = 'model-item';
                        div.innerHTML = `
                            <div>
                                <strong>${model.id}</strong><br>
                                <small>Available</small>
                            </div>
                        `;
                        list.appendChild(div);
                    });
                    
                    document.getElementById('models-count').textContent = data.models.length;
                    addLog(`üìã Loaded ${data.models.length} models: ${data.models.map(m => m.id).join(', ')}`);
                } else {
                    select.innerHTML = '<option value="">No models available</option>';
                    list.innerHTML = '<div style="text-align: center; color: #666; padding: 20px;">No models found. Start Foundry first.</div>';
                    document.getElementById('models-count').textContent = '0';
                    addLog(`‚ö†Ô∏è No models available: ${data.error || 'Foundry not running'}`);
                }
            } catch (error) {
                addLog(`‚ùå Failed to load models: ${error.message}`);
            }
        }

        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            const model = document.getElementById('model-select').value;
            
            if (!message) return;
            if (!model) {
                alert('Please select a model first!');
                return;
            }
            
            // Add user message
            addChatMessage('user', message);
            input.value = '';
            
            // Add typing indicator
            const typingId = addChatMessage('assistant', '‚è≥ Generating...');
            
            try {
                const response = await fetch(`${API_BASE}/generate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        prompt: message,
                        model: model,
                        temperature: parseFloat(document.getElementById('temperature').value),
                        max_tokens: 2048
                    })
                });
                
                const data = await response.json();
                
                // Remove typing indicator
                document.getElementById(typingId).remove();
                
                if (data.success) {
                    addChatMessage('assistant', data.content);
                    addLog(`‚úÖ Generated response (${data.model})`);
                } else {
                    addChatMessage('assistant', `‚ùå Error: ${data.error}`);
                    addLog(`‚ùå Generation failed: ${data.error}`);
                }
            } catch (error) {
                document.getElementById(typingId).remove();
                addChatMessage('assistant', `‚ùå Connection error: ${error.message}`);
                addLog(`‚ùå Request failed: ${error.message}`);
            }
        }

        function addChatMessage(role, content) {
            const container = document.getElementById('chat-messages');
            const messageId = 'msg-' + Date.now();
            
            // Clear placeholder
            if (container.children.length === 1 && container.textContent.includes('Start chatting')) {
                container.innerHTML = '';
            }
            
            const div = document.createElement('div');
            div.id = messageId;
            div.className = `message ${role}`;
            div.textContent = content;
            
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            
            return messageId;
        }

        async function startFoundry() {
            const btn = document.getElementById('start-foundry');
            btn.disabled = true;
            btn.textContent = '‚è≥ Starting...';
            
            try {
                const response = await fetch(`${API_BASE}/foundry/start`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();
                
                if (data.success) {
                    addLog('‚úÖ Foundry started successfully');
                    setTimeout(() => {
                        refreshStatus();
                        loadModels();
                    }, 3000);
                } else {
                    addLog(`‚ùå Failed to start Foundry: ${data.error}`);
                }
            } catch (error) {
                addLog(`‚ùå Start request failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚ñ∂Ô∏è Start Foundry';
            }
        }

        async function stopFoundry() {
            const btn = document.getElementById('stop-foundry');
            btn.disabled = true;
            btn.textContent = '‚è≥ Stopping...';
            
            try {
                const response = await fetch(`${API_BASE}/foundry/stop`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();
                
                if (data.success) {
                    addLog('‚úÖ Foundry stopped');
                    refreshStatus();
                } else {
                    addLog(`‚ùå Failed to stop Foundry: ${data.error}`);
                }
            } catch (error) {
                addLog(`‚ùå Stop request failed: ${error.message}`);
            } finally {
                btn.disabled = false;
                btn.textContent = '‚èπÔ∏è Stop Foundry';
            }
        }

        async function testConnection() {
            addLog('üîç Testing connection...');
            await refreshStatus();
            await loadModels();
        }

        async function generateSample() {
            const model = document.getElementById('model-select').value;
            if (!model) {
                alert('Please select a model first!');
                return;
            }
            
            document.getElementById('chat-input').value = 'Hello! Can you tell me about yourself?';
            await sendMessage();
        }

        function clearChat() {
            document.getElementById('chat-messages').innerHTML = `
                <div style="text-align: center; color: #666; margin-top: 50px;">
                    Start chatting with AI models
                </div>
            `;
            chatHistory = [];
            addLog('üóëÔ∏è Chat cleared');
        }

        function exportLogs() {
            const logs = document.getElementById('system-logs').textContent;
            const blob = new Blob([logs], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `foundry-logs-${new Date().toISOString().slice(0,10)}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function addLog(message) {
            const logs = document.getElementById('system-logs');
            const timestamp = new Date().toLocaleTimeString();
            logs.textContent += `[${timestamp}] ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
    </script>
</body>
</html>